name: Test

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  test-common:
    runs-on: ubuntu-latest
    name: Test Common Libraries
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Test common libraries
      run: mvn test -pl common/common-dto,common/common-exception,common/common-util,common/common-security,common/common-event
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: common-test-results
        path: |
          common/*/target/surefire-reports/
        retention-days: 7
  
  test-services:
    runs-on: ubuntu-latest
    name: Test Services
    strategy:
      matrix:
        service: 
          - auth-service
          - book-service
          - user-service
          - borrowing-service
          - notification-service
          - saga-orchestrator-service
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build common libraries
      run: mvn clean install -pl common/common-dto,common/common-exception,common/common-util,common/common-security,common/common-event -am -DskipTests
    
    - name: Test ${{ matrix.service }}
      run: mvn test -pl services/${{ matrix.service }}
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.service }}-test-results
        path: |
          services/${{ matrix.service }}/target/surefire-reports/
        retention-days: 7
  
  test-infrastructure:
    runs-on: ubuntu-latest
    name: Test Infrastructure Services
    strategy:
      matrix:
        service:
          - api-gateway
          - service-discovery
          - config-server
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Test ${{ matrix.service }}
      run: mvn test -pl infrastructure/${{ matrix.service }}
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.service }}-test-results
        path: |
          infrastructure/${{ matrix.service }}/target/surefire-reports/
        retention-days: 7
